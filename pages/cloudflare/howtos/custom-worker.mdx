## Custom Worker

The worker generated by the Cloudflare adapter only exports [a fetch handler](https://developers.cloudflare.com/workers/runtime-apis/handlers/fetch/).

Sometimes your application needs to expose another type of handler (i.e. [a scheduled handler](https://developers.cloudflare.com/workers/runtime-apis/handlers/scheduled/)) or export a [Durable Object](https://developers.cloudflare.com/durable-objects/api/base/). This can be achieved by creating a custom worker.

The custom worker re-uses the generated fetch handler.

### Create your custom worker Worker

The following custom worker re-uses the generated fetch handler and adds a scheduled handler:

```ts
// custom-worker.ts

// @ts-ignore `.open-next/worker.ts` is generated at build time
import { default as handler } from "./.open-next/worker.js";

export default {
  fetch: handler.fetch,

  async scheduled(event) {
    // ...
  },
} satisfies ExportedHandler<CloudflareEnv>;

// The re-export is only required if your app uses the DO Queue and DO Tag Cache
// See https://opennext.js.org/cloudflare/caching for details
// @ts-ignore `.open-next/worker.ts` is generated at build time
export { DOQueueHandler, DOShardedTagCache } from "./.open-next/worker.js";
```

See [an example in the adapter repository](https://github.com/opennextjs/opennextjs-cloudflare/blob/main/examples/playground14/worker.ts).

You can also use [PartyServer](https://github.com/cloudflare/partykit/blob/main/packages/partyserver/README.md) to work with websockets easily.

> **_Note:_** PartyServer only handles requests matching its PartyKit-style routing. All other requests will fall through to the OpenNext handler below.

```ts
// custom-worker.ts

// @ts-ignore `.open-next/worker.ts` is generated at build time
import { default as handler } from "./.open-next/worker.js";
import { routePartykitRequest, Server } from "partyserver";

export class MyServer extends Server {
  onConnect(connection) {
    console.log("Connected", connection.id, "to server", this.name);
  }

  onMessage(connection, message) {
    console.log("Message from", connection.id, ":", message);
    // Send the message to every other connection
    this.broadcast(message, [connection.id]);
  }
}

export default {
  async fetch(request: Request, env: CloudflareEnv, ctx: ExecutionContext) {
    // Route PartyServer websocket/room traffic to the Durable Object.
    const partyResponse = await routePartykitRequest(request);
    if (partyResponse) return partyResponse;

    // Everything else goes to the OpenNext handler.
    return handler.fetch(request, env, ctx);
  },
} satisfies ExportedHandler<CloudflareEnv>;

// The re-export is only required if your app uses the DO Queue and DO Tag Cache
// See https://opennext.js.org/cloudflare/caching for details
// @ts-ignore `.open-next/worker.ts` is generated at build time
export { DOQueueHandler, DOShardedTagCache } from "./.open-next/worker.js";
```

Since `Server` from PartyServer is a Durable Object, you need to configure your wrangler.jsonc:

```jsonc
// wrangler.jsonc
"durable_objects": {
  "bindings": [
    {
      "name": "MY_SERVER",
      "class_name": "MyServer"
    }
  ]
},
"migrations": [
  {
    "tag": "v1",
    "new_classes": ["MyServer"]
  }
]
```

### Update the entry point in your wrangler configuration

```diff
// wrangler.jsonc
{
-  "main": "./.open-next/worker.js"
+  "main": "./path/to/custom-worker.ts",
}
```
